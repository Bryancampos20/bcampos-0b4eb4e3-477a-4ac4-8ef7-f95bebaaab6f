<div class="app-shell flex flex-col">
  <!-- Top bar -->
  <header class="app-header">
    <div>
      <h1 class="app-header-title">Task Management</h1>
      <p class="app-header-subtitle">
        Logged in as
        <span class="font-medium">{{ currentUser?.email }}</span>
        <span class="ml-1 app-badge-muted uppercase">
          {{ currentUser?.role }}
        </span>
      </p>
    </div>

    <div class="flex items-center gap-3">
      <button
        *ngIf="!isViewer"
        routerLink="/audit-log"
        class="app-button-ghost"
      >
        View audit log
      </button>

      <button (click)="logout()" class="app-button-ghost">
        Logout
      </button>

      <button
        type="button"
        (click)="toggleTheme()"
        class="app-button-ghost text-xs"
      >
        <span class="mr-1" *ngIf="isDarkMode; else sun">üåô</span>
        <ng-template #sun>‚òÄÔ∏è</ng-template>
        {{ isDarkMode ? 'Dark' : 'Light' }}
      </button>
    </div>
  </header>

  <!-- Main content -->
  <div class="flex-1 flex flex-col lg:flex-row gap-6 p-6">
    <!-- Task board (Kanban) -->
    <section class="flex-1 app-card app-card-padding">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Tasks</h2>
        <span class="text-xs text-slate-500 dark:text-slate-400">
          {{ tasks.length }} task{{ tasks.length === 1 ? '' : 's' }}
        </span>
      </div>

      <!-- Toolbar: filter + sort -->
      <div
        class="flex flex-wrap items-center gap-3 mb-4 text-xs text-slate-600 dark:text-slate-300"
      >
        <div class="flex items-center gap-1">
          <span>Category:</span>
          <select
            [(ngModel)]="categoryFilter"
            name="categoryFilter"
            class="app-select h-8 py-1 text-xs w-32"
          >
            <option [ngValue]="'ALL'">All</option>
            <option *ngFor="let cat of categoryOptions" [ngValue]="cat.value">
              {{ cat.label }}
            </option>
          </select>
        </div>

        <div class="flex items-center gap-1">
          <span>Sort by:</span>
          <select
            [(ngModel)]="sortBy"
            name="sortBy"
            class="app-select h-8 py-1 text-xs w-40"
          >
            <option value="createdAt_desc">Newest first</option>
            <option value="createdAt_asc">Oldest first</option>
            <option value="title_asc">Title A‚ÄìZ</option>
          </select>
        </div>

        <!-- Toggle button for completion overview -->
        <button
          type="button"
          class="app-button-ghost h-8 px-3"
          [disabled]="totalTasks === 0"
          (click)="toggleOverview()"
        >
          {{ showOverview ? 'Hide completion overview' : 'Show completion overview' }}
        </button>
      </div>

      <!-- Task completion visualization (simple horizontal bar chart) -->
      <div
        *ngIf="totalTasks > 0 && showOverview"
        class="mb-4 rounded-xl border border-slate-200 dark:border-slate-700 bg-slate-50/80 dark:bg-slate-900/80 p-3 text-xs"
      >
        <div class="flex items-center justify-between mb-2">
          <span class="font-semibold text-slate-800 dark:text-slate-100 text-sm">
            Task completion overview
          </span>
          <span class="text-slate-500 dark:text-slate-400">
            {{ statusCounts['DONE'] || 0 }} of {{ totalTasks }} completed
            ({{ getStatusPercent('DONE') }}%)
          </span>
        </div>

        <div class="space-y-2">
          <div *ngFor="let s of statusOptions">
            <div class="flex justify-between mb-1">
              <span class="text-slate-700 dark:text-slate-200">
                {{ s.label }}
              </span>
              <span class="text-slate-500 dark:text-slate-400">
                {{ statusCounts[s.value] || 0 }} ¬∑
                {{ getStatusPercent(s.value) }}%
              </span>
            </div>
            <div class="h-2 rounded-full bg-slate-200 dark:bg-slate-800 overflow-hidden">
              <div
                class="h-full transition-all"
                [style.width]="getStatusPercent(s.value) + '%'"
                [ngClass]="{
                  'bg-sky-500': s.value === 'OPEN',
                  'bg-amber-500': s.value === 'IN_PROGRESS',
                  'bg-violet-500': s.value === 'CODE_REVIEW',
                  'bg-emerald-500': s.value === 'DONE'
                }"
              ></div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="loading" class="text-sm text-slate-500 dark:text-slate-400">
        Loading tasks‚Ä¶
      </div>

      <div *ngIf="error" class="text-sm text-red-500 mt-2">
        {{ error }}
      </div>

      <div
        *ngIf="!loading && tasks.length === 0"
        class="text-sm text-slate-500 mt-4 dark:text-slate-400"
      >
        No tasks yet. Use the form on the right to create one.
      </div>

      <!-- Board -->
      <div
        *ngIf="tasks.length > 0"
        class="mt-4 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4"
      >
        <div
          *ngFor="let col of statusOptions"
          class="flex flex-col bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl p-3"
        >
          <!-- Column header -->
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center gap-2">
              <span class="text-sm font-semibold text-slate-700 dark:text-slate-100">
                {{ col.label }}
              </span>
              <span class="app-badge-muted text-[10px]">
                {{ tasksByStatus(col.value).length }}
              </span>
            </div>
          </div>

          <!-- Drop area -->
          <div
            class="flex-1 rounded-lg border border-dashed border-slate-200 dark:border-slate-600 bg-slate-50/70 dark:bg-slate-900/40 p-2 space-y-2 min-h-[120px]"
            (dragover)="onDragOver($event)"
            (drop)="onDrop($event, col.value)"
          >
            <p
              *ngIf="tasksByStatus(col.value).length === 0"
              class="text-[11px] text-slate-400 italic"
            >
              Drop tasks here to set them as {{ col.label.toLowerCase() }}.
            </p>

            <!-- Task cards -->
            <article
              *ngFor="let task of tasksByStatus(col.value)"
              class="rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 px-3 py-2 shadow-sm cursor-move"
              [attr.draggable]="canModifyTasks ? true : null"
              (dragstart)="onDragStart(task)"
            >
              <div class="flex items-start justify-between gap-2">
                <!-- T√≠tulo + descripci√≥n -->
                <div class="flex-1 min-w-0">
                  <h3
                    class="text-sm font-semibold text-slate-800 dark:text-slate-100 app-ellipsis"
                  >
                    {{ task.title }}
                  </h3>
                  <p
                    *ngIf="task.description"
                    class="mt-1 text-xs text-slate-600 dark:text-slate-300 app-ellipsis"
                  >
                    {{ task.description || '‚Äî' }}
                  </p>
                </div>

                <!-- Badge de categor√≠a -->
                <span class="app-badge text-[10px] flex-shrink-0">
                  {{ task.category }}
                </span>
              </div>

              <div class="mt-2 flex items-center justify-between">
                <span
                  class="app-badge text-[10px]"
                  [ngClass]="{
                    'bg-sky-100 text-sky-700 dark:bg-sky-800 dark:text-sky-100':
                      task.status === 'OPEN',
                    'bg-amber-100 text-amber-800 dark:bg-amber-700 dark:text-amber-50':
                      task.status === 'IN_PROGRESS',
                    'bg-violet-100 text-violet-800 dark:bg-violet-700 dark:text-violet-50':
                      task.status === 'CODE_REVIEW',
                    'bg-emerald-100 text-emerald-800 dark:bg-emerald-700 dark:text-emerald-50':
                      task.status === 'DONE'
                  }"
                >
                  {{ task.status }}
                </span>

                <div *ngIf="canModifyTasks; else viewerActions" class="flex gap-2">
                  <button
                    type="button"
                    class="app-button-ghost text-[11px] px-2 py-1"
                    (click)="startEdit(task)"
                  >
                    Edit
                  </button>
                  <button
                    type="button"
                    class="app-button-danger text-[11px] px-2 py-1"
                    (click)="deleteTask(task)"
                  >
                    Delete
                  </button>
                </div>

                <ng-template #viewerActions>
                  <span class="text-[10px] text-slate-400 italic">
                    Read-only
                  </span>
                </ng-template>
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>

    <!-- Form -->
    <section class="w-full lg:w-80 app-card app-card-padding">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">
          {{ editingTaskId ? 'Edit task' : 'Create task' }}
        </h2>
      </div>

      <div *ngIf="isViewer" class="text-xs text-slate-500 mb-2">
        You are signed in as <span class="font-medium">VIEWER</span>. Task
        creation and modifications are disabled.
      </div>

      <form
        (ngSubmit)="submitForm()"
        class="space-y-3"
        [class.opacity-60]="!canModifyTasks"
      >
        <div>
          <label class="app-label">Title</label>
          <input
            type="text"
            [(ngModel)]="formTitle"
            name="title"
            [disabled]="!canModifyTasks"
            class="app-input"
            placeholder="Short task title"
            required
          />
        </div>

        <div>
          <label class="app-label">Description</label>
          <textarea
            [(ngModel)]="formDescription"
            name="description"
            [disabled]="!canModifyTasks"
            rows="3"
            class="app-textarea"
            placeholder="Optional description"
          ></textarea>
        </div>

        <div class="flex gap-2">
          <div class="flex-1">
            <label class="app-label">Category</label>
            <select
              [(ngModel)]="formCategory"
              name="category"
              [disabled]="!canModifyTasks"
              class="app-select"
              required
            >
              <option
                *ngFor="let cat of categoryOptions"
                [ngValue]="cat.value"
              >
                {{ cat.label }}
              </option>
            </select>
          </div>

          <div class="w-40">
            <label class="app-label">Status</label>
            <select
              [(ngModel)]="formStatus"
              name="status"
              [disabled]="!canModifyTasks"
              class="app-select"
            >
              <option *ngFor="let s of statusOptions" [ngValue]="s.value">
                {{ s.label }}
              </option>
            </select>
          </div>
        </div>

        <div class="flex gap-2 pt-1">
          <button
            type="submit"
            [disabled]="!canModifyTasks"
            class="app-button-primary flex-1"
          >
            {{ editingTaskId ? 'Save changes' : 'Create task' }}
          </button>

          <button
            type="button"
            (click)="resetForm()"
            class="app-button-ghost"
          >
            Cancel
          </button>
        </div>
      </form>
    </section>
  </div>
</div>
